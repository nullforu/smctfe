import { getCategoryKey, useT } from '../lib/i18n'
import type { Challenge } from '../lib/types'

interface ChallengeCardProps {
    challenge: Challenge
    isSolved: boolean
    onClick: () => void
}

const ChallengeCard = ({ challenge, isSolved, onClick }: ChallengeCardProps) => {
    const t = useT()

    return (
        <div
            className={`rounded-2xl border p-6 transition cursor-pointer hover:shadow-lg ${
                challenge.is_active
                    ? 'border-border bg-surface hover:border-accent'
                    : 'border-border/40 bg-surface-muted opacity-60'
            }`}
            onClick={onClick}
            role='button'
            tabIndex={0}
            onKeyDown={(event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault()
                    onClick()
                }
            }}
        >
            <div className='flex items-start justify-between'>
                <div className='flex-1'>
                    <h3 className='text-lg font-medium text-text'>{challenge.title}</h3>
                    <div className='mt-2 flex flex-wrap items-center gap-2 text-sm'>
                        <span className='rounded-full bg-surface-subtle px-2.5 py-0.5 text-xs font-medium text-text'>
                            {t(getCategoryKey(challenge.category))}
                        </span>
                        <span className='text-text-muted'>{t('common.pointsShort', { points: challenge.points })}</span>
                    </div>
                </div>
                {isSolved ? (
                    <span className='rounded-full bg-success/20 px-3 py-1 text-xs text-success'>
                        {t('challenge.solvedLabel')}
                    </span>
                ) : !challenge.is_active ? (
                    <span className='rounded-full bg-surface/10 px-3 py-1 text-xs text-text-muted'>
                        {t('challenge.inactiveLabel')}
                    </span>
                ) : null}
            </div>
        </div>
    )
}

interface ChallengesViewProps {
    title: string
    summaryText?: string
    showSummary: boolean
    groupByCategory: boolean
    toggleLabel: string
    onGroupByCategoryChange: (checked: boolean) => void
    loading: boolean
    loadingText: string
    errorMessage: string
    notStarted: boolean
    notStartedText: string
    startAtLabel: string
    startAtValue: string
    endAtLabel: string
    endAtValue: string
    ended: boolean
    endedText: string
    challenges: Challenge[]
    groupedCategories: Array<{ id: string; label: string; items: Challenge[] }>
    solvedIds: Set<number>
    onSelectChallenge: (challenge: Challenge) => void
}

const ChallengesView = ({
    title,
    summaryText,
    showSummary,
    groupByCategory,
    toggleLabel,
    onGroupByCategoryChange,
    loading,
    loadingText,
    errorMessage,
    notStarted,
    notStartedText,
    startAtLabel,
    startAtValue,
    endAtLabel,
    endAtValue,
    ended,
    endedText,
    challenges,
    groupedCategories,
    solvedIds,
    onSelectChallenge,
}: ChallengesViewProps) => {
    const renderChallengeGrid = (items: Challenge[]) => (
        <div className='mt-6 grid gap-6 md:grid-cols-2 lg:grid-cols-3'>
            {items.map((challenge) => (
                <ChallengeCard
                    key={challenge.id}
                    challenge={challenge}
                    isSolved={solvedIds.has(challenge.id)}
                    onClick={() => onSelectChallenge(challenge)}
                />
            ))}
        </div>
    )

    const renderGroupedChallenges = () => (
        <div className='mt-6 space-y-8'>
            {groupedCategories.map((category) => {
                if (category.items.length === 0) return null

                return (
                    <div key={category.id}>
                        <h3 className='text-lg font-semibold text-text'>{category.label}</h3>
                        <div className='mt-4 grid gap-6 md:grid-cols-2 lg:grid-cols-3'>
                            {category.items.map((challenge) => (
                                <ChallengeCard
                                    key={challenge.id}
                                    challenge={challenge}
                                    isSolved={solvedIds.has(challenge.id)}
                                    onClick={() => onSelectChallenge(challenge)}
                                />
                            ))}
                        </div>
                    </div>
                )
            })}
        </div>
    )

    const renderChallenges = () => (groupByCategory ? renderGroupedChallenges() : renderChallengeGrid(challenges))

    const renderBody = () => {
        if (loading) {
            return (
                <div className='mt-6 rounded-2xl border border-border bg-surface p-8 text-center text-text-muted'>
                    {loadingText}
                </div>
            )
        }

        if (errorMessage) {
            return (
                <div className='mt-6 rounded-2xl border border-danger/40 bg-danger/10 p-6 text-sm text-danger'>
                    {errorMessage}
                </div>
            )
        }

        if (notStarted) {
            return (
                <div className='mt-6 space-y-3 rounded-2xl border border-warning/40 bg-warning/10 p-6 text-sm text-warning-strong'>
                    <p>{notStartedText}</p>
                    <div className='text-xs text-text-muted'>
                        <p>
                            {startAtLabel}: {startAtValue}
                        </p>
                        <p>
                            {endAtLabel}: {endAtValue}
                        </p>
                    </div>
                </div>
            )
        }

        return (
            <>
                {ended ? (
                    <div className='mt-6 rounded-2xl border border-warning/40 bg-warning/10 p-6 text-sm text-warning-strong'>
                        {endedText}
                    </div>
                ) : null}
                {renderChallenges()}
            </>
        )
    }

    return (
        <section className='fade-in'>
            <div className='flex flex-wrap items-end justify-between gap-4'>
                <div>
                    <h2 className='text-3xl text-text'>{title}</h2>
                </div>
                {showSummary && summaryText ? (
                    <div className='rounded-full border border-border bg-surface px-4 py-2 text-xs text-text'>
                        {summaryText}
                    </div>
                ) : null}
            </div>
            <div className='mt-4 flex items-center justify-end'>
                <label className='flex items-center gap-2 text-xs text-text-muted'>
                    <input
                        className='h-4 w-4 accent-accent'
                        type='checkbox'
                        checked={groupByCategory}
                        onChange={(event) => onGroupByCategoryChange(event.target.checked)}
                    />
                    <span>{toggleLabel}</span>
                </label>
            </div>

            {renderBody()}
        </section>
    )
}

export default ChallengesView
